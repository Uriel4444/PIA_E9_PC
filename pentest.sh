#!/bin/bash

pentest() {
	TARGET=$1
	LOG_FILE="pentest_report_$TARGET.txt"
	# Verifica si el script se ejecuta como root
	if [ "$EUID" -ne 0 ]; then
    		echo "Por favor, ejecuta el script como root."
    	return 1
  	fi

  	# Verifica si se pasó un objetivo como argumento
  	if [ -z "$TARGET" ]; then
   		echo "Uso: realizar_pentest <IP del objetivo>"
    	return 1
  	fi

  	DATE_GMT6=$(TZ="America/Mexico_City" date)

  	echo "==== Script de Pen_Test ====" | tee -a $LOG_FILE
  	echo "Objetivo: $TARGET" | tee -a $LOG_FILE
  	echo "Fecha (GMT-6): $DATE_GMT6" | tee -a $LOG_FILE
  	echo "============================" | tee -a $LOG_FILE

  	# Fase 1: Ping al objetivo para verificar si está activo
  	echo ".-Fase 1: Ping al objetivo..." | tee -a $LOG_FILE
  	ping -c 4 $TARGET > /dev/null
  	if [ $? -eq 0 ]; then
    		echo "* El objetivo está activo." | tee -a $LOG_FILE
 	else
    		echo "~ El objetivo no responde a ping." | tee -a $LOG_FILE
    	return 1
  	fi

  	# Fase 2: Escaneo de puertos con nmap
  	echo ".-Fase 2: Escaneo de puertos abiertos con nmap..." | tee -a $LOG_FILE
  	nmap -p- --open $TARGET | tee -a $LOG_FILE

  	# Fase 3: Escaneo de versiones y vulnerabilidades
  	echo ".-Fase 3: Escaneo de versiones de servicios y posibles vulnerabilidades..." | tee -a $LOG_FILE
  	nmap -sV --script vuln $TARGET | tee -a $LOG_FILE

  	# Fase 4: Enumeración de servicios si están presentes
  	echo ".-Fase 4: Enumeración de servicios disponibles..." | tee -a $LOG_FILE

  	# Enumerar FTP si el puerto 21 está abierto
  	ftp_check=$(grep "21/tcp" $LOG_FILE)
  	if [ ! -z "$ftp_check" ]; then
    		echo "* Enumerando FTP en $TARGET..." | tee -a $LOG_FILE
    	nmap --script ftp-anon $TARGET -p 21 | tee -a $LOG_FILE
  	else
    		echo "~ El servicio FTP no está disponible." | tee -a $LOG_FILE
  	fi

  	# Enumerar SMB si el puerto 445 está abierto
  	smb_check=$(grep "445/tcp" $LOG_FILE)
  	if [ ! -z "$smb_check" ]; then
    		echo "* Enumerando SMB en $TARGET..." | tee -a $LOG_FILE
    	nmap --script smb-enum-shares,smb-enum-users $TARGET -p 445 | tee -a $LOG_FILE
  	else
    		echo "~ El servicio SMB no está disponible." | tee -a $LOG_FILE
  	fi

  	# Enumerar HTTP si el puerto 80 o 443 está abierto
  	http_check=$(grep -E "80/tcp|443/tcp" $LOG_FILE)
  	if [ ! -z "$http_check" ]; then
    		echo "* Enumerando servicios HTTP en $TARGET..." | tee -a $LOG_FILE
    	nmap --script http-enum $TARGET -p 80,443 | tee -a $LOG_FILE
  	else
   		echo "~ El servicio HTTP no está disponible." | tee -a $LOG_FILE
  	fi

  	echo "* Prueba de penetración completada. Los resultados están guardados en $LOG_FILE" | tee -a $LOG_FILE

  	# Recomendaciones para el usuario
  	echo "==== Recomendaciones para tener una mejor Seguridad====" | tee -a $LOG_FILE
  	echo "1.- Revisa las vulnerabilidades identificadas en los servicios expuestos y considera actualizarlos o aplicar parches si están desactualizados." | tee -a $LOG_FILE
  	echo "2.- Deshabilita los servicios innecesarios que se encontraron abiertos (FTP, SMB, HTTP, etc.) para reducir la superficie de ataque." | tee -a $LOG_FILE
  	echo "3.- Implementa reglas de firewall para limitar el acceso a los puertos críticos, permitiendo solo IPs o rangos de confianza." | tee -a $LOG_FILE
  	echo "4.- Configura autenticación robusta y usa mecanismos como 2FA en los servicios críticos (SSH, FTP, etc.) para mejorar la seguridad." | tee -a $LOG_FILE
  	echo "5.- Monitorea los logs del sistema regularmente para detectar actividad sospechosa en los servicios que están en uso." | tee -a $LOG_FILE
}
